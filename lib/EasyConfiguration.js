// Generated by CoffeeScript 1.6.3
(function() {
  var EasyConfiguration, Extension, Helpers, merge;

  merge = require('recursive-merge');

  Extension = require('./Extension');

  Helpers = require('./Helpers');

  EasyConfiguration = (function() {
    EasyConfiguration.PARAMETER_REGEXP = /%([a-zA-Z.-_]+)%/g;

    EasyConfiguration.prototype.fileName = null;

    EasyConfiguration.prototype.reserved = null;

    EasyConfiguration.prototype.env = null;

    EasyConfiguration.prototype.extensions = null;

    EasyConfiguration.prototype.files = null;

    EasyConfiguration.prototype._parameters = null;

    EasyConfiguration.prototype.parameters = null;

    EasyConfiguration.prototype.data = null;

    function EasyConfiguration(fileName) {
      this.fileName = fileName;
      this.reserved = ['includes', 'parameters', 'common'];
      this.extensions = {};
      this.files = [];
      this._parameters = {};
      this.parameters = {};
    }

    EasyConfiguration.prototype.getEnvironment = function() {
      if (this.env === null) {
        this.env = (typeof process === "function" ? process(typeof env === "function" ? env(typeof NODE_ENV !== "undefined" && NODE_ENV !== null) : void 0) : void 0) ? process.env.NODE_ENV : 'production';
      }
      return this.env;
    };

    EasyConfiguration.prototype.setEnvironment = function(env) {
      this.env = env;
      return this.reserved.push(this.env);
    };

    EasyConfiguration.prototype.addSection = function(name) {
      return this.addExtension(name, new Extension);
    };

    EasyConfiguration.prototype.addExtension = function(name, extension) {
      if (Helpers.arrayIndexOf(this.reserved, name) !== -1) {
        throw new Error('Extension\'s name ' + name + ' is reserved.');
      }
      extension.configurator = this;
      this.extensions[name] = extension;
      return this.extensions[name];
    };

    EasyConfiguration.prototype.removeExtension = function(name) {
      if (typeof this.extensions[name] === 'undefined') {
        throw new Error('Extension with name ' + name + ' was not found.');
      }
      delete this.extensions[name];
      this.invalidate();
      return this;
    };

    EasyConfiguration.prototype.invalidate = function() {
      this.data = null;
      return this;
    };

    EasyConfiguration.prototype.load = function() {
      var config, data;
      if (this.data === null) {
        config = this.loadConfig(this.fileName, true);
        data = this.parse(config);
        this.files = data.files;
        this.parameters = data.parameters;
        this.data = data.sections;
      }
      return this.data;
    };

    EasyConfiguration.prototype.loadConfig = function(file, main) {
      var data, env, include, path, _data, _i, _len, _ref;
      if (main == null) {
        main = false;
      }
      data = require(file);
      data = Helpers.clone(data, false);
      env = this.getEnvironment();
      if (main && (typeof data[env] !== 'undefined' || typeof data.common !== 'undefined')) {
        if (typeof data.common !== 'undefined') {
          _data = data.common;
          if (typeof data[env] !== 'undefined') {
            _data = this.merge(data[env], _data);
          }
        } else {
          _data = data[env];
        }
        data = _data;
      }
      if (typeof data.includes !== 'undefined') {
        _ref = data.includes;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          include = _ref[_i];
          path = Helpers.normalizePath(Helpers.dirName(file) + '/' + include);
          data = this.merge(data, this.loadConfig(path));
        }
      }
      return data;
    };

    EasyConfiguration.prototype.parse = function(data) {
      var name, result, section, sections, _ref;
      result = {
        files: [],
        parameters: {},
        sections: {}
      };
      if (typeof data.includes !== 'undefined') {
        result.files = data.includes;
      }
      if (typeof data.parameters !== 'undefined') {
        this._parameters = data.parameters;
        result.parameters = this.expandParameters(data.parameters);
      }
      _ref = this.extensions;
      for (name in _ref) {
        section = _ref[name];
        if (typeof data[name] === 'undefined') {
          data[name] = {};
        }
      }
      sections = data;
      if (typeof sections.parameters !== 'undefined') {
        delete sections.parameters;
      }
      if (typeof sections.includes !== 'undefined') {
        delete sections.includes;
      }
      for (name in sections) {
        section = sections[name];
        if (sections.hasOwnProperty(name) && (name !== '__proto__')) {
          if (typeof this.extensions[name] === 'undefined') {
            throw new Error('Found section ' + name + ' but there is no coresponding extension.');
          }
          this.extensions[name].data = section;
          section = this.extensions[name].loadConfiguration();
          section = this.expandParameters(section);
          section = this.extensions[name].afterCompile(section);
          result.sections[name] = section;
        }
      }
      return result;
    };

    EasyConfiguration.prototype.expandParameters = function(parameters) {
      var name, param, parse, type, _i, _len, _type,
        _this = this;
      _type = Object.prototype.toString;
      parse = function(name, param) {
        switch (_type.call(param)) {
          case '[object String]':
            return parameters[name] = param.replace(EasyConfiguration.PARAMETER_REGEXP, function(match, variable) {
              return _this._getParameter(variable, [name]);
            });
          case '[object Object]':
          case '[object Array]':
            return parameters[name] = _this.expandParameters(param);
          default:
            return parameters[name] = param;
        }
      };
      type = _type.call(parameters);
      switch (type) {
        case '[object Object]':
          for (name in parameters) {
            param = parameters[name];
            parse(name, param);
          }
          break;
        case '[object Array]':
          for (name = _i = 0, _len = parameters.length; _i < _len; name = ++_i) {
            param = parameters[name];
            parse(name, param);
          }
          break;
        default:
          throw new Error("Can not parse " + type + " parameters.");
      }
      return parameters;
    };

    EasyConfiguration.prototype._getParameter = function(parameter, previous) {
      var actual, part, parts, s, _i, _len,
        _this = this;
      if (previous == null) {
        previous = [];
      }
      parts = parameter.split('.');
      actual = this._parameters;
      for (_i = 0, _len = parts.length; _i < _len; _i++) {
        part = parts[_i];
        if (typeof actual[part] === 'undefined') {
          throw new Error("Parameter " + parameter + " is not defined.");
        }
        actual = actual[part];
      }
      if (Helpers.arrayIndexOf(previous, parameter) !== -1) {
        s = previous.length === 1 ? '' : 's';
        previous = previous.join(', ');
        throw new Error("Found circular reference in parameter" + s + " " + previous + ".");
      }
      previous.push(parameter);
      actual = actual.replace(EasyConfiguration.PARAMETER_REGEXP, function(match, param) {
        return _this._getParameter(param, previous);
      });
      return actual;
    };

    EasyConfiguration.prototype.getParameter = function(parameter) {
      return this._getParameter(parameter);
    };

    EasyConfiguration.prototype.merge = function(left, right) {
      right = Helpers.clone(right, false);
      return merge(left, right);
    };

    return EasyConfiguration;

  })();

  module.exports = EasyConfiguration;

}).call(this);
