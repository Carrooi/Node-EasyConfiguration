// Generated by CoffeeScript 1.6.3
(function() {
  var EasyConfiguration, Extension, Helpers, clone, merge;

  merge = require('recursive-merge');

  clone = require('clone');

  Extension = require('./Extension');

  Helpers = require('./Helpers');

  EasyConfiguration = (function() {
    EasyConfiguration.prototype.fileName = null;

    EasyConfiguration.prototype.reserved = ['includes', 'parameters'];

    EasyConfiguration.prototype.extensions = null;

    EasyConfiguration.prototype.files = null;

    EasyConfiguration.prototype._parameters = null;

    EasyConfiguration.prototype.parameters = null;

    EasyConfiguration.prototype.data = null;

    function EasyConfiguration(fileName) {
      this.fileName = fileName;
      this.extensions = {};
      this.files = [];
      this._parameters = {};
      this.parameters = {};
    }

    EasyConfiguration.prototype.addSection = function(name) {
      return this.addExtension(name, new Extension);
    };

    EasyConfiguration.prototype.addExtension = function(name, extension) {
      if (Helpers.arrayIndexOf(this.reserved, name) !== -1) {
        throw new Error('Extension\'s name ' + name + ' is reserved.');
      }
      extension.configurator = this;
      this.extensions[name] = extension;
      return this.extensions[name];
    };

    EasyConfiguration.prototype.removeExtension = function(name) {
      if (typeof this.extensions[name] === 'undefined') {
        throw new Error('Extension with name ' + name + ' was not found.');
      }
      delete this.extensions[name];
      this.invalidate();
      return this;
    };

    EasyConfiguration.prototype.invalidate = function() {
      this.data = null;
      return this;
    };

    EasyConfiguration.prototype.load = function() {
      var config, data;
      if (this.data === null) {
        config = this.loadConfig(this.fileName);
        data = this.parse(config);
        this.files = data.files;
        this.parameters = data.parameters;
        this.data = data.sections;
      }
      return this.data;
    };

    EasyConfiguration.prototype.loadConfig = function(file) {
      var data, include, path, _i, _len, _ref;
      data = require(file);
      data = clone(data, false);
      if (typeof data.includes !== 'undefined') {
        _ref = data.includes;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          include = _ref[_i];
          path = Helpers.normalizePath(Helpers.dirName(file) + '/' + include);
          data = this.merge(data, this.loadConfig(path));
        }
      }
      return data;
    };

    EasyConfiguration.prototype.parse = function(data) {
      var name, result, section, sections, _ref;
      result = {
        files: [],
        parameters: {},
        sections: {}
      };
      if (typeof data.includes !== 'undefined') {
        result.files = data.includes;
      }
      if (typeof data.parameters !== 'undefined') {
        this._parameters = data.parameters;
        result.parameters = this.expandParameters(data.parameters);
      }
      _ref = this.extensions;
      for (name in _ref) {
        section = _ref[name];
        if (typeof data[name] === 'undefined') {
          data[name] = {};
        }
      }
      sections = data;
      if (typeof sections.parameters !== 'undefined') {
        delete sections.parameters;
      }
      if (typeof sections.includes !== 'undefined') {
        delete sections.includes;
      }
      for (name in sections) {
        section = sections[name];
        if (sections.hasOwnProperty(name) && (name !== '__proto__')) {
          if (typeof this.extensions[name] === 'undefined') {
            throw new Error('Found section ' + name + ' but there is no coresponding extension.');
          }
          this.extensions[name].data = section;
          section = this.extensions[name].loadConfiguration();
          section = this.expandParameters(section);
          section = this.extensions[name].afterCompile(section);
          result.sections[name] = section;
        }
      }
      return result;
    };

    EasyConfiguration.prototype.expandParameters = function(parameters) {
      var name, param, parse, type, _i, _len, _type,
        _this = this;
      _type = Object.prototype.toString;
      parse = function(name, param) {
        switch (_type.call(param)) {
          case '[object String]':
            return parameters[name] = param.replace(/%([a-zA-Z.-_]+)%/g, function(match, variable) {
              return _this.getParameter(variable);
            });
          case '[object Object]':
          case '[object Array]':
            return parameters[name] = _this.expandParameters(param);
          default:
            return parameters[name] = param;
        }
      };
      type = _type.call(parameters);
      switch (type) {
        case '[object Object]':
          for (name in parameters) {
            param = parameters[name];
            parse(name, param);
          }
          break;
        case '[object Array]':
          for (name = _i = 0, _len = parameters.length; _i < _len; name = ++_i) {
            param = parameters[name];
            parse(name, param);
          }
          break;
        default:
          throw new Error("Can not parse " + type + " parameters.");
      }
      return parameters;
    };

    EasyConfiguration.prototype.getParameter = function(parameter) {
      var actual, part, parts, _i, _len;
      parts = parameter.split('.');
      actual = this._parameters;
      for (_i = 0, _len = parts.length; _i < _len; _i++) {
        part = parts[_i];
        if (typeof actual[part] === 'undefined') {
          throw new Error("Parameter " + parameter + " is not defined.");
        }
        actual = actual[part];
      }
      return actual;
    };

    EasyConfiguration.prototype.merge = function(left, right) {
      right = clone(right, false);
      return merge(left, right);
    };

    return EasyConfiguration;

  })();

  module.exports = EasyConfiguration;

}).call(this);
